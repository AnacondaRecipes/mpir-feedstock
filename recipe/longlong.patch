From b84e7e24ca24fd4a965017ff56c25728d2d10fdc Mon Sep 17 00:00:00 2001
From: Brian Gladman <brg@gladman.plus.com>
Date: Sat, 18 Jun 2016 13:27:19 +0100
Subject: [PATCH] remove 'long/long long' pointer bug on Windows x64

---
 build.vc11/mpir-tests/run-tests.py     | 3 ++-
 build.vc12/mpir-tests/run-tests.py     | 3 ++-
 build.vc14/mpir-tests/run-tests.py     | 3 ++-
 build.vc14/mpir-tune/tune/tune.vcxproj | 2 ++
 gmp-h.in                               | 4 ++--
 mpf/get_d_2exp.c                       | 4 ++--
 mpz/get_d_2exp.c                       | 4 ++--
 tests/mpf/t-get_d_2exp.c               | 2 +-
 tests/mpz/t-get_d_2exp.c               | 2 +-
 9 files changed, 16 insertions(+), 11 deletions(-)

diff --git a/build.vc11/mpir-tests/run-tests.py b/build.vc11/mpir-tests/run-tests.py
index 6a2b3a9..97db4c1 100644
--- build.vc11/mpir-tests/run-tests.py
+++ build.vc11/mpir-tests/run-tests.py
@@ -14,7 +14,8 @@
 import re
 
 cw, f = os.path.split(__file__)
-os.chdir(cw)
+if cw != ''
+  os.chdir(cw)
 
 try:
   fn = r'..\..\build.vc\output_params.bat'
diff --git a/build.vc12/mpir-tests/run-tests.py b/build.vc12/mpir-tests/run-tests.py
index 6a2b3a9..97db4c1 100644
--- build.vc12/mpir-tests/run-tests.py
+++ build.vc12/mpir-tests/run-tests.py
@@ -14,7 +14,8 @@
 import re
 
 cw, f = os.path.split(__file__)
-os.chdir(cw)
+if cw != ''
+  os.chdir(cw)
 
 try:
   fn = r'..\..\build.vc\output_params.bat'
diff --git a/build.vc14/mpir-tests/run-tests.py b/build.vc14/mpir-tests/run-tests.py
index 6a2b3a9..15f8daa 100644
--- build.vc14/mpir-tests/run-tests.py
+++ build.vc14/mpir-tests/run-tests.py
@@ -14,7 +14,8 @@
 import re
 
 cw, f = os.path.split(__file__)
-os.chdir(cw)
+if cw != '':
+  os.chdir(cw)
 
 try:
   fn = r'..\..\build.vc\output_params.bat'
diff --git a/build.vc14/mpir-tune/tune/tune.vcxproj b/build.vc14/mpir-tune/tune/tune.vcxproj
index 2bf936b..7964158 100644
--- build.vc14/mpir-tune/tune/tune.vcxproj
+++ build.vc14/mpir-tune/tune/tune.vcxproj
@@ -673,6 +673,8 @@
   <ItemGroup>
     <YASM Include="sqr_basecase.asm">
       <FileType>Document</FileType>
+      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">true</ExcludedFromBuild>
+      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">true</ExcludedFromBuild>
     </YASM>
   </ItemGroup>
   <ItemGroup>
diff --git a/gmp-h.in b/gmp-h.in
index 4b7de80..f8d4962 100644
--- gmp-h.in
+++ gmp-h.in
@@ -915,7 +915,7 @@ __GMP_DECLSPEC void mpz_gcdext __GMP_PROTO ((mpz_ptr, mpz_ptr, mpz_ptr, mpz_srcp
 __GMP_DECLSPEC double mpz_get_d __GMP_PROTO ((mpz_srcptr)) __GMP_ATTRIBUTE_PURE;
 
 #define mpz_get_d_2exp __gmpz_get_d_2exp
-__GMP_DECLSPEC double mpz_get_d_2exp __GMP_PROTO ((mpir_si *, mpz_srcptr));
+__GMP_DECLSPEC double mpz_get_d_2exp __GMP_PROTO ((signed long *, mpz_srcptr));
 
 #define mpz_get_si __gmpz_get_si
 __GMP_DECLSPEC /* signed */ mpir_si mpz_get_si __GMP_PROTO ((mpz_srcptr)) __GMP_NOTHROW __GMP_ATTRIBUTE_PURE;
@@ -1443,7 +1443,7 @@ __GMP_DECLSPEC void mpf_floor __GMP_PROTO ((mpf_ptr, mpf_srcptr));
 __GMP_DECLSPEC double mpf_get_d __GMP_PROTO ((mpf_srcptr)) __GMP_ATTRIBUTE_PURE;
 
 #define mpf_get_d_2exp __gmpf_get_d_2exp
-__GMP_DECLSPEC double mpf_get_d_2exp __GMP_PROTO ((mpir_si *, mpf_srcptr));
+__GMP_DECLSPEC double mpf_get_d_2exp __GMP_PROTO ((signed long *, mpf_srcptr));
 
 #define mpf_get_default_prec __gmpf_get_default_prec
 __GMP_DECLSPEC mp_bitcnt_t mpf_get_default_prec __GMP_PROTO ((void)) __GMP_NOTHROW __GMP_ATTRIBUTE_PURE;
diff --git a/mpf/get_d_2exp.c b/mpf/get_d_2exp.c
index e1bfe1a..e58f466 100644
--- mpf/get_d_2exp.c
+++ mpf/get_d_2exp.c
@@ -25,12 +25,12 @@ MA 02110-1301, USA. */
 
 
 double
-mpf_get_d_2exp (mpir_si *exp2, mpf_srcptr src)
+mpf_get_d_2exp (signed long *exp2, mpf_srcptr src)
 {
   mp_size_t size, abs_size;
   mp_srcptr ptr;
   int cnt;
-  mpir_si exp;
+  signed long exp;
 
   size = SIZ(src);
   if (UNLIKELY (size == 0))
diff --git a/mpz/get_d_2exp.c b/mpz/get_d_2exp.c
index e36c3cd..8251f90 100644
--- mpz/get_d_2exp.c
+++ mpz/get_d_2exp.c
@@ -24,12 +24,12 @@ MA 02110-1301, USA. */
 #include "longlong.h"
 
 double
-mpz_get_d_2exp (mpir_si *exp2, mpz_srcptr src)
+mpz_get_d_2exp (signed long *exp2, mpz_srcptr src)
 {
   mp_size_t size, abs_size;
   mp_srcptr ptr;
   int cnt;
-  mpir_si exp;
+  signed long exp;
 
   size = SIZ(src);
   if (UNLIKELY (size == 0))
diff --git a/tests/mpf/t-get_d_2exp.c b/tests/mpf/t-get_d_2exp.c
index 4fdcfcf..2459fbc 100644
--- tests/mpf/t-get_d_2exp.c
+++ tests/mpf/t-get_d_2exp.c
@@ -35,7 +35,7 @@ check_onebit (void)
   };
   mpf_t   f;
   double  got, want;
-  mpir_si got_exp, want_exp;
+  signed long got_exp, want_exp;
   int     i,sign;
 
   mpf_init2(f,1024L);
diff --git a/tests/mpz/t-get_d_2exp.c b/tests/mpz/t-get_d_2exp.c
index 0d6d6ab..ef34484 100644
--- tests/mpz/t-get_d_2exp.c
+++ tests/mpz/t-get_d_2exp.c
@@ -34,7 +34,7 @@ check_onebit (void)
   };
   mpz_t   z;
   double  got, want;
-  mpir_si    got_exp, want_exp;
+  signed long got_exp, want_exp;
   int     i;
 
   mpz_init (z);
